---
title: "US Top Income Share vs Tax Rates (1913 ~ 2014)"
author: "coop711"
date: "`r Sys.Date()`"
output: html_document
---

## Data Preparation

준비한 자료는  [E. Saez 교수의 홈페이지](http://elsa.berkeley.edu/~saez/)에 있는 `TabFig2014prel.xls` 와 [Tax Foundation](http://taxfoundation.org/)에서 제공하는 자료를 손봐서 불러들인 것이다. 

```{r, data preparation, message = FALSE, echo = FALSE, results = 'hide'}
options(digits = 2)
# library(xlsx)
load("US_top_income_shares_2014_add.rda")
# US.top.income.shares.14 <- read.xlsx("../data/TabFig2014prel.xlsx", sheetIndex = 9, sheetName = "Table A3", startRow = 6, endRow = 107, colIndex = c(1:7, 9:13), header = FALSE)
# v.names <- read.xlsx("./data/TabFig2014prel.xlsx", sheetName = "Table A3", startRow = 4, endRow = 4, colIndex = c(2:7, 9:14), colClasses = character, header = FALSE)
#str(US.top.income.shares.14)
v.names <- c("Year", "P90_100", "P95_100", "P99_100", "P99.5_100", "P99.9_100", "P99.99_100", "P90_95", "P95_99", "P99_99.5", "P99.5_99.9", "P99.9_99.99")
names(US.top.income.shares.14) <- v.names
tax.rates <- read.table("../data/federal_income_tax_rates.txt", header = FALSE)
names(tax.rates) <- c("Year", "Lowest", "Marginal")
```

<!--작업을 마친 자료파일은 `US.top.income.shares.14`이며, 이 자료의 구조와 앞의 몇 열의 값은 다음과 같다.-->

```{r, data structure, echo = FALSE}
library(knitr)
top.income_tax <- cbind(US.top.income.shares.14[c("Year", "P90_100", "P99_100", "P99.9_100", "P99.99_100")], tax.rates[-1, 2:3])
kable(top.income_tax)
```

이 중에서 소득 상위 1%(`P99_100`)몫과 최고세율(Marginal Tax Rates) 간의 관계를 살펴보자

```{r, top 1 percent shares vs MTR,  fig.width = 12, fig.height = 6.75}
par(mar = c(5, 6, 4, 6) + 0.1)
plot(P99_100 ~ Year, data = top.income_tax, type = "l", lty = 1, axes = FALSE, ann = FALSE, ylim = c(5, 25))
box()
axis(side = 1, at = seq(1910, 2010, by = 10), labels = seq(1910, 2010, by = 10))
axis(side = 2, at = seq(5, 25, by = 5), labels = seq(5, 25, by = 5), las = 1, ylab = "Top Income Share")
mtext("Top Income Share(%)", side = 2, line = 3)
par(new = TRUE)
plot(Marginal ~ Year, data = top.income_tax, type ="l", lty = 2, axes = FALSE, ann = FALSE, ylim = c(0, 100))
axis(side = 4, at = seq(0, 100, by = 20), labels = seq(0, 100, by = 20), las = 1)
mtext("Marginal Tax Rates(%)", side = 4, line = 3)
```

 
## ggplot

### Data Reshaping

* `reshape2` 패키지를 이용하여 wide format 을 long format 으로

```{r, reshape}
library(reshape2)
top.income_tax.melt <- melt(top.income_tax, id.vars = "Year", measure.vars = c("P99_100", "Lowest", "Marginal"), variable.name = "Income_vs_Tax", value.name = "Percentage")
str(top.income_tax.melt)
```

t0 <- ggplot(data.01.melt, aes(x = Year, y = Share, colour = Percentiles)) + 
  geom_line(na.rm = TRUE) + 
  geom_point(shape = 24, aes(fill = Percentiles), size = 2, na.rm = TRUE) + 
  ylim(0, 8)
t1 <- t0 + 
  theme_bw()
t2 <- t1 + 
   theme(panel.grid.major = element_line(linetype = "dotted", colour = "black"))
t3 <- t2 + 
  scale_x_continuous(breaks = seq(1910, 2010, by = 10))
t4 <- t3 + 
   theme.kr + 
   xlab("연도") + 
   ylab("소득점유(%)")
t5 <- t4 + 
   ggtitle(main.title.3) + 
   theme(plot.title = element_text(size = 20))
t6 <- t5 + 
   labs(colour = "소득 분위", fill = "소득 분위")
t7 <- t6 +
   scale_colour_manual(name = "", values = c("black", "blue"), labels = legend.text.3) +
   scale_fill_manual(name = "", values = c("black", "blue"), labels = legend.text.3)
t8 <- t7 + 
   theme(legend.position =  c(0.5, 0.85))
t9 <- t8 + 
   guides(colour ="none")
t10 <- t9 + 
   theme(legend.title = element_blank(), legend.background = element_rect(fill = "white", colour = "black"))
t11 <- t10 + 
   theme(legend.key = element_blank())
t12 <- t11 + 
   annotate("text", x = c(1928, 2007), y = c(6.8, 6.5), label = c(1928, 2007))
t13 <- t12 + 
  annotate("text", x = c(1935, 1960, 2014), y = c(5.6, 2.8, 3.0), label = times.label, colour = "red", family = "HCR Dotum LVT", size = 8)
```

ggsave

```{r, ggsave}
# ggsave("../pics/US_top_income_share_1-4-5_2014_ggplot.png", width = 12, height = 6.75)
```

<!--## 뒷 정리

```{r, save.image}
save.image(file = "US_top_income_shares_vs_tax_rates.rda")
```
-->
